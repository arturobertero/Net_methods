---
title: "Data_managment"
author: "Arturo Bertero"
date: "2025-11-26"
output: html_document
---

# Input

```{r}
#Libraries
library(pacman)
p_load(tidyverse, here, summarytools, janitor, mice)

#Options
rm(list = ls())
options(scipen = 99)
```

```{r}
#Data 
data = read.csv(here("Input", "anes.csv")) %>%
  clean_names() 
  
```

# Processing

```{r}
# pid
data = data %>% 
  mutate(
    # First clean raw variables: negative values or >= 95 become NA
    pid_raw   = ifelse(v241221 < 0 | v241221 >= 95, NA, v241221),
    pid_str   = ifelse(v241222 < 0 | v241222 >= 95, NA, v241222),
    pid_lean  = ifelse(v241223 < 0 | v241223 >= 95, NA, v241223),

    # Now build the canonical 7-category PID
    party_id = case_when(
      
      # Strong Democrat
      pid_raw == 1 & pid_str == 1 ~ 1,
      # Weak Democrat
      pid_raw == 1 & pid_str == 2 ~ 2,
      
      # Lean Democrat (from Independent/No pref/Other)
      pid_raw %in% c(0,3,5) & pid_lean == 3 ~ 3,
      
      # Pure Independent
      pid_raw %in% c(0,3,5) & pid_lean == 2 ~ 4,
      
      # Lean Republican
      pid_raw %in% c(0,3,5) & pid_lean == 1 ~ 5,
      
      # Weak Republican
      pid_raw == 2 & pid_str == 2 ~ 6,
      # Strong Republican
      pid_raw == 2 & pid_str == 1 ~ 7,
      
      TRUE ~ NA_real_
    )
  )

#nice recode
data = data %>% 
mutate(
    party_id = factor(party_id,
      levels = 1:7,
      labels = c(
        "Strong Dem", "Weak Dem", "Lean Dem",
        "Pure Ind",
        "Lean Rep", "Weak Rep", "Strong Rep"
      )
    )
  )

# other vars
anes <- data %>% 
  transmute( #select and rename
    # Attitudes 
    Abortion     = v241248,
    Black        = v241255,
    Law_order    = v241397,
    Gov_services = v241239,
    Defense      = v241242,
    Insurance    = v241245,
    Environment  = v241258,
    
    # Others
    Lib_cons  = v241177,
    Gender    = v241003,
    Pol_int   = v241004,
    Education = v241463,
    Party_id  = party_id
  ) %>%
  
  # for attitudes keep only 1-7
  mutate(
    across(
      c(Abortion, Black, Law_order, Gov_services, Defense, Insurance, Environment),
      ~ ifelse(.x %in% 1:7, as.numeric(.x), NA_real_)
    ),
    
    # Gov_services polarity flip: 1 (liberal) -> 7, 7 (conservative) -> 1
    Gov_services = ifelse(!is.na(Gov_services), 8 - Gov_services, NA_real_)
  ) %>%
  
  # libcons
  mutate(
    Lib_cons = ifelse(Lib_cons < 0 | Lib_cons >= 95, NA_real_, as.numeric(Lib_cons))
  ) %>%
  
  # gender
  mutate(
    gender_raw = Gender,
    Gender = case_when(
      Gender < 0 ~ NA_integer_,     # negative values as NA
      Gender == 1 ~ 1L,             # Man
      Gender == 2 ~ 2L,             # Woman
      TRUE ~ 3L                     # Anything else as Other
    ),
    Gender = factor(
      Gender,
      levels = c(1, 2, 3),
      labels = c("Man", "Woman", "Other")
    )
  ) %>%
  
  # pol_int
  mutate(
    Pol_int = ifelse(Pol_int < 0, NA_real_, as.numeric(Pol_int)),
    # Original: 1 = Always, 5 = Never â†’ we want high = high interest
    Pol_int = ifelse(!is.na(Pol_int), 6 - Pol_int, NA_real_)
  ) %>%
  
  # educ
  mutate(
    Education = ifelse(Education < 0 | Education >= 95, NA_integer_, as.integer(Education)),
    
    educ_3cat = case_when(
      Education %in% 1:9  ~ "Low",   # Up to HS diploma
      Education %in% 10:12 ~ "Mid",  # Some college or Associate's degree
      Education %in% 13:16 ~ "High", # Bachelor+, Master, Professional, Doctorate
      TRUE ~ NA_character_
    ),
    
    Education = factor(educ_3cat, levels = c("Low", "Mid", "High"))
  ) %>% 
  # remove helper vars
  select(-c(gender_raw, educ_3cat))

```

```{r}
#Inspect
map(anes, ~ table(.x, useNA = "always"))
```

```{r}
# MICE
anes_mice <- anes %>%
  mutate(
    # attitudes, lib cons and pol interest are numeric
    across(
      c(Abortion, Black, Law_order, Gov_services,
        Defense, Insurance, Environment,
        Lib_cons, Pol_int),
      as.numeric
    ),
    
    # Education: 3-cat ordered factor
    Education = factor(Education, levels = c("Low", "Mid", "High"), ordered = TRUE),
    
    # Party_id: 7-point ordered factor 
    Party_id = factor(
      Party_id,
      levels = c(
        "Strong Dem", "Weak Dem", "Lean Dem",
        "Pure Ind",
        "Lean Rep", "Weak Rep", "Strong Rep"
      ),
      ordered = TRUE
    ),
    
    # Gender: unordered factor (Man / Woman / Other)
    Gender = factor(Gender)
  )

meth <- make.method(anes_mice)
pred <- make.predictorMatrix(anes_mice)

# Attitudes + ideology + political interest: numeric; use pmm
num_vars <- c(
  "Abortion", "Black", "Law_order", "Gov_services",
  "Defense", "Insurance", "Environment",
  "Lib_cons", "Pol_int"
)
meth[num_vars] <- "pmm"

# Categorical / ordinal vars
meth["Gender"]    <- "polyreg"  # multinomial logit
meth["Education"] <- "polr"     # ordinal
meth["Party_id"]  <- "polr"     # ordinal

imp <- mice(
  anes_mice,
  m = 10,
  maxit = 20,
  method = meth,
  predictorMatrix = pred,
  seed = 1234
)

anes_imputed <- complete(imp, 1)
```


# Output

```{r}
# rename dataset and na omit 
anes_na_omit = na.omit(anes)
anes_full = anes


saveRDS(anes_na_omit, here( "Input", "anes_na_omit.RDS"))
saveRDS(anes_full, here( "Input", "anes_full.RDS"))
saveRDS(anes_imputed, here( "Input", "anes_imputed.RDS"))

```

